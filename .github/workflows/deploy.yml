name: Deploy to EC2

on:
  push:
    branches: [ main ]

jobs:
  # 1. ë°±ì—”ë“œ ë¹Œë“œ (Java Spring Boot)
  build-backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Grant execute permission for gradlew
        run: chmod +x backend/gradlew

      - name: Build with Gradle
        run: |
          cd backend
          ./gradlew clean build -x test

      - name: Upload Backend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: backend/build/libs/*.jar

  # 2. í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ (Next.js)
  build-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          cd frontend
          npm ci

      - name: Build Next.js
        env:
          # ë¹Œë“œ ì‹œì ì— ë°±ì—”ë“œ API ì£¼ì†Œë¥¼ ì£¼ìž… (EC2 í¼ë¸”ë¦­ IP)
          NEXT_PUBLIC_API_URL: http://${{ secrets.EC2_HOST }}:8080
        run: |
          cd frontend
          npm run build

      - name: Upload Frontend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: |
            frontend/.next
            frontend/public
            frontend/package.json
            frontend/next.config.mjs

  # 3. EC2ë¡œ ë°°í¬
  deploy:
    needs: [build-backend, build-frontend]
    runs-on: ubuntu-latest
    steps:
      - name: Download Backend Artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-jar
          path: backend-artifact

      - name: Download Frontend Artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend-artifact

      # íŒŒì¼ ì „ì†¡ (SCP) - ë°±ì—”ë“œ Jar
      - name: Transfer Backend Jar to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "backend-artifact/*.jar"
          target: "~/app/backend"
          strip_components: 1

      # íŒŒì¼ ì „ì†¡ (SCP) - í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ê²°ê³¼ë¬¼
      - name: Transfer Frontend Files to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "frontend-artifact/*"
          target: "~/app/frontend"
          strip_components: 1

      # ì„œë²„ ìž¬ì‹œìž‘ (SSH)
      - name: Restart Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          # Secrets í™˜ê²½ë³€ìˆ˜ ì£¼ìž…
          envs: DB_URL, DB_USERNAME, DB_PASSWORD, AWS_ACCESS_KEY, AWS_SECRET_KEY, S3_BUCKET_NAME, JWT_SECRET, S3_UPLOAD_DIR, S3_UPLOAD_URL_PREFIX, FRONTEND_URL
          script: |
            # 1. ë©”ëª¨ë¦¬ í™•ë³´ (ìºì‹œ ë¹„ìš°ê¸°) - t3.micro í•„ìˆ˜ ì•ˆì „ìž¥ì¹˜
            echo "ðŸ§¹ Clearing memory cache..."
            sudo sysctl -w vm.drop_caches=3
            free -h

            # 2. ë°±ì—”ë“œ ìž¬ì‹œìž‘
            echo "ðŸ”¥ Backend Deploy Start..."
            
            # (ìˆ˜ì •ë¨) 'java' ë¼ëŠ” ì´ë¦„ì˜ í”„ë¡œì„¸ìŠ¤ë§Œ ì°¾ì•„ì„œ ì¢…ë£Œ (ìŠ¤í¬ë¦½íŠ¸ ìžì‚´ ë°©ì§€)
            # pgrep -x java : í”„ë¡œì„¸ìŠ¤ ì´ë¦„ì´ ì •í™•ížˆ javaì¸ ê²ƒë§Œ ì°¾ìŒ
            CURRENT_PID=$(pgrep -x java)
            
            if [ -z $CURRENT_PID ]; then
              echo "> í˜„ìž¬ ì‹¤í–‰ ì¤‘ì¸ Java í”„ë¡œì„¸ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤."
            else
              echo "> ì‹¤í–‰ ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ: $CURRENT_PID"
              kill -15 $CURRENT_PID
              sleep 5
              # ì•ˆ ì£½ì—ˆìœ¼ë©´ í™•ì¸ ì‚¬ì‚´
              kill -9 $CURRENT_PID 2>/dev/null || true
            fi

            # ìƒˆ Jar ì‹¤í–‰ (nohupìœ¼ë¡œ ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰)
            nohup java -jar \
              -Dspring.profiles.active=prod \
              -DDB_URL=$DB_URL \
              -DDB_USERNAME=$DB_USERNAME \
              -DDB_PASSWORD=$DB_PASSWORD \
              -DAWS_ACCESS_KEY=$AWS_ACCESS_KEY \
              -DAWS_SECRET_KEY=$AWS_SECRET_KEY \
              -DS3_BUCKET_NAME=$S3_BUCKET_NAME \
              -DJWT_SECRET=$JWT_SECRET \
              -DS3_UPLOAD_DIR=$S3_UPLOAD_DIR \
              -DS3_UPLOAD_URL_PREFIX=$S3_UPLOAD_URL_PREFIX \
              -DFRONTEND_URL=$FRONTEND_URL \
              ~/app/backend/*.jar > ~/app/backend/nohup.out 2>&1 &
              
            echo "âœ… Backend Deploy Complete!"

            # 2. í”„ë¡ íŠ¸ì—”ë“œ ìž¬ì‹œìž‘
            echo "ðŸ”¥ Frontend Deploy Start..."
            cd ~/app/frontend
            
            # ì˜ì¡´ì„± ì„¤ì¹˜ (í”„ë¡œë•ì…˜ìš©ë§Œ ê°€ë³ê²Œ)
            npm install --production
            
            # PM2ë¡œ Next.js ìž¬ì‹œìž‘ (ì—†ìœ¼ë©´ ì‹œìž‘, ìžˆìœ¼ë©´ ë¦¬ë¡œë“œ)
            pm2 describe techblog-front > /dev/null
            if [ $? -eq 0 ]; then
              pm2 reload techblog-front
            else
              pm2 start npm --name "techblog-front" -- start
            fi
            
            echo "âœ… Frontend Deploy Complete!"